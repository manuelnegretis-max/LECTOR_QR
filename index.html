<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    
    <title>QR Ultra Scanner - Samsung A73 Bond Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #818cf8; }
        body { background-color: #000; color: #fff; overflow-x: hidden; font-family: system-ui, -apple-system, sans-serif; }
        
        #reader {
            width: 100%;
            height: 60vh !important;
            border: none !important;
            background: #000;
        }

        /* FILTROS CRÍTICOS PARA PAPEL BOND */
        #reader__scan_region video {
            object-fit: cover !important;
            filter: grayscale(1) contrast(1.5) brightness(1.2) !important;
            image-rendering: crisp-edges;
        }

        #reader__dashboard { display: none !important; }

        .focus-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px; height: 280px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 48px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.7);
            z-index: 5;
            pointer-events: none;
        }
        
        .focus-ring::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 4px solid var(--primary);
            border-radius: 50px;
            mask-image: linear-gradient(to bottom, black 20%, transparent 20%, transparent 80%, black 80%), 
                        linear-gradient(to right, black 20%, transparent 20%, transparent 80%, black 80%);
            -webkit-mask-image: linear-gradient(to bottom, black 20%, transparent 20%, transparent 80%, black 80%), 
                                linear-gradient(to right, black 20%, transparent 20%, transparent 80%, black 80%);
        }

        .scan-line {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 260px; height: 2px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            animation: scanMove 2s ease-in-out infinite;
            z-index: 6;
        }

        @keyframes scanMove {
            0%, 100% { transform: translate(-50%, -120px); opacity: 0; }
            50% { transform: translate(-50%, 120px); opacity: 1; }
        }

        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 35px; width: 35px;
            background: #fff;
            border-radius: 50%;
            border: 3px solid var(--primary);
        }
    </style>
</head>
<body class="antialiased select-none">

    <div class="relative min-h-screen flex flex-col">
        <!-- Area de Video -->
        <div class="relative flex-1 overflow-hidden">
            <div id="reader"></div>
            <div class="focus-ring"></div>
            <div class="scan-line"></div>
            
            <div class="absolute top-10 left-0 right-0 flex justify-center z-50">
                <div id="status-pill" class="bg-black/50 backdrop-blur-md border border-white/10 px-6 py-2 rounded-full">
                    <span id="status-text" class="text-[10px] font-black tracking-[0.2em] uppercase text-indigo-300">Modo Lectura Bond</span>
                </div>
            </div>
        </div>

        <!-- Controles Inferiores -->
        <div class="bg-zinc-950 rounded-t-[3.5rem] p-8 pb-12 shadow-2xl z-20 -mt-14 border-t border-white/5">
            
            <!-- Zoom Avanzado -->
            <div id="zoom-area" class="hidden mb-8 space-y-4">
                <div class="flex justify-between items-center px-2">
                    <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Enfoque Digital</span>
                    <span id="zoom-val" class="text-sm font-black text-indigo-400">1.0x</span>
                </div>
                <div class="flex items-center gap-4">
                    <button id="z-out" class="w-14 h-14 bg-zinc-900 rounded-2xl flex items-center justify-center text-2xl active:scale-90 transition-all">－</button>
                    <input id="z-slider" type="range" step="0.1" class="flex-1 h-2 bg-zinc-900 rounded-lg appearance-none custom-range">
                    <button id="z-in" class="w-14 h-14 bg-zinc-900 rounded-2xl flex items-center justify-center text-2xl active:scale-90 transition-all">＋</button>
                </div>
            </div>

            <!-- Botones Principales -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <button id="btn-main" class="bg-indigo-600 h-20 rounded-[2.5rem] font-black text-lg active:scale-95 transition-all shadow-lg shadow-indigo-500/20">
                    <span id="txt-main">LECTURA</span>
                </button>
                <button id="btn-export" class="bg-zinc-900 h-20 rounded-[2.5rem] font-black text-lg active:scale-95 border border-white/5">
                    EXCEL
                </button>
            </div>

            <!-- Historial -->
            <div class="space-y-4">
                <div class="flex justify-between items-center px-4">
                    <h3 class="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Capturas</h3>
                    <button id="btn-reset" class="text-[10px] text-zinc-800 font-black uppercase">Limpiar</button>
                </div>
                <div id="log-list" class="max-h-36 overflow-y-auto space-y-2 px-2 custom-scrollbar">
                    <p id="empty-hint" class="text-center py-8 text-zinc-800 font-bold text-xs uppercase italic">Apunta al código para capturar</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        let html5Qr = null;
        let scans = [];
        let videoTrack = null;

        async function init() {
            html5Qr = new Html5Qrcode("reader");
            
            const config = { 
                fps: 30, 
                qrbox: { width: 280, height: 280 },
                aspectRatio: 1.0,
                // OPTIMIZACIÓN SAMSUNG A73: Forzar resolución alta para detalles en papel
                videoConstraints: {
                    facingMode: "environment",
                    width: { min: 1280, ideal: 1920, max: 3840 },
                    height: { min: 720, ideal: 1080, max: 2160 }
                },
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true // Usar motor nativo de Android si está disponible
                }
            };

            document.getElementById('btn-main').onclick = async function() {
                const label = document.getElementById('txt-main');
                if (label.innerText === "LECTURA") {
                    try {
                        await html5Qr.start({ facingMode: "environment" }, config, onFound);
                        label.innerText = "DETENER";
                        this.classList.replace('bg-indigo-600', 'bg-zinc-800');
                        
                        // Esperar a que el hardware de Samsung responda
                        setTimeout(syncCameraHardware, 1500);
                    } catch (e) {
                        alert("Error de acceso: " + e);
                    }
                } else {
                    location.reload();
                }
            };
        }

        async function syncCameraHardware() {
            try {
                videoTrack = html5Qr.getRunningTrack();
                if (!videoTrack) return;

                const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
                
                if (capabilities.zoom) {
                    const area = document.getElementById('zoom-area');
                    const slider = document.getElementById('z-slider');
                    const valTxt = document.getElementById('zoom-val');
                    
                    area.classList.remove('hidden');
                    slider.min = capabilities.zoom.min;
                    slider.max = capabilities.zoom.max;
                    slider.step = capabilities.zoom.step;
                    
                    const setZoom = (v) => {
                        videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(v) }] }).catch(() => {});
                        valTxt.innerText = parseFloat(v).toFixed(1) + "x";
                    };

                    slider.oninput = (e) => setZoom(e.target.value);
                    document.getElementById('z-in').onclick = () => {
                        let n = Math.min(parseFloat(slider.value) + 0.5, capabilities.zoom.max);
                        slider.value = n; setZoom(n);
                    };
                    document.getElementById('z-out').onclick = () => {
                        let n = Math.max(parseFloat(slider.value) - 0.5, capabilities.zoom.min);
                        slider.value = n; setZoom(n);
                    };

                    // AUTO-ZOOM PREVENTIVO: El lente del A73 enfoca mejor el papel a 1.6x
                    setTimeout(() => {
                        slider.value = 1.6;
                        setZoom(1.6);
                    }, 1000);
                }
            } catch (err) { console.warn("Hardware no disponible", err); }
        }

        function onFound(text) {
            // Anti-rebote para no repetir el mismo código
            if (scans.length > 0 && scans[0].data === text) return;

            document.getElementById('beep').play();
            if (navigator.vibrate) navigator.vibrate(100);

            scans.unshift({
                data: text,
                time: new Date().toLocaleTimeString([], { hour12: false })
            });

            const pill = document.getElementById('status-pill');
            const status = document.getElementById('status-text');
            
            status.innerText = "CAPTURA REALIZADA";
            pill.classList.replace('bg-black/50', 'bg-emerald-600');
            
            render();
            
            setTimeout(() => {
                status.innerText = "Modo Lectura Bond";
                pill.classList.replace('bg-emerald-600', 'bg-black/50');
            }, 1200);
        }

        function render() {
            const list = document.getElementById('log-list');
            const hint = document.getElementById('empty-hint');
            if (scans.length) hint.style.display = 'none';
            
            list.innerHTML = scans.map(s => `
                <div class="bg-zinc-900/80 p-5 rounded-[1.5rem] flex justify-between items-center border border-white/5 animate-in slide-in-from-right duration-300">
                    <span class="text-[10px] font-black text-indigo-400 font-mono">${s.time}</span>
                    <span class="text-sm font-bold text-zinc-100 truncate ml-4 flex-1 text-right">${s.data}</span>
                </div>
            `).join('');
        }

        document.getElementById('btn-export').onclick = () => {
            if (!scans.length) return;
            const ws = XLSX.utils.json_to_sheet(scans);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Registros");
            XLSX.writeFile(wb, `Inventario_${Date.now()}.xlsx`);
        };

        document.getElementById('btn-reset').onclick = () => {
            if (confirm("¿Limpiar historial?")) {
                scans = [];
                render();
                document.getElementById('empty-hint').style.display = 'block';
            }
        };

        window.onload = init;
    </script>
</body>
</html>
