<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    
    <title>QR Smart Scanner Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1;
        }
        body {
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
        }
        #reader {
            width: 100%;
            height: 70vh !important;
            border: none !important;
            background: #000;
        }
        #reader__scan_region video {
            object-fit: cover !important;
            image-rendering: auto;
        }
        /* Ocultar elementos internos de la librería */
        #reader__dashboard, #reader__status_span { display: none !important; }
        
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            border: 2px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        .scanner-focus-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 260px;
            height: 260px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 40px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
        }
        .scanner-focus-box::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            border: 4px solid var(--primary);
            border-radius: 40px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.5; transform: scale(1); }
        }
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 30px; width: 30px;
            background: #fff;
            border-radius: 50%;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="font-sans antialiased">

    <div class="relative min-h-screen flex flex-col">
        <!-- Visor de Cámara -->
        <div class="relative flex-1 overflow-hidden">
            <div id="reader"></div>
            <div class="scan-overlay">
                <div class="scanner-focus-box"></div>
            </div>
            
            <!-- Indicador de Estado Flotante -->
            <div id="status-pill" class="absolute top-8 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-md px-6 py-2 rounded-full border border-white/20 z-50 transition-all duration-300">
                <span class="text-[10px] font-bold tracking-widest uppercase opacity-80">IA de Enfoque Activa</span>
            </div>
        </div>

        <!-- Panel de Control Inferior -->
        <div class="bg-zinc-900 rounded-t-[3rem] p-8 pb-12 shadow-2xl z-20 -mt-10">
            
            <!-- Zoom Inteligente -->
            <div id="zoom-ctrl" class="hidden mb-8">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">Ajuste de Zoom</span>
                    <span id="zoom-display" class="text-indigo-400 font-black text-sm">1.0x</span>
                </div>
                <div class="flex items-center gap-6">
                    <button id="zoom-down" class="w-12 h-12 rounded-full bg-zinc-800 flex items-center justify-center text-2xl font-light active:scale-90 transition-transform">－</button>
                    <input id="zoom-slider" type="range" step="0.1" class="flex-1 h-1.5 bg-zinc-800 rounded-lg appearance-none custom-slider">
                    <button id="zoom-up" class="w-12 h-12 rounded-full bg-zinc-800 flex items-center justify-center text-2xl font-light active:scale-90 transition-transform">＋</button>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <button id="main-btn" class="bg-indigo-600 h-20 rounded-3xl font-black text-lg shadow-lg shadow-indigo-500/20 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <div id="btn-icon" class="w-3 h-3 bg-white rounded-full animate-ping"></div>
                    <span id="btn-text">INICIAR</span>
                </button>
                <button id="dl-btn" class="bg-zinc-800 h-20 rounded-3xl font-black text-lg active:scale-95 transition-all text-indigo-400 border border-indigo-500/20">
                    EXCEL
                </button>
            </div>

            <!-- Lista de Escaneos Estilo Samsung -->
            <div class="space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h3 class="text-xs font-black text-zinc-500 uppercase tracking-widest">Capturas Recientes</h3>
                    <button id="clear-all" class="text-[10px] text-zinc-600 font-bold uppercase hover:text-red-400">Limpiar Todo</button>
                </div>
                <div id="log-container" class="max-h-40 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                    <div id="empty-msg" class="text-center py-8 text-zinc-700 italic text-sm">Apunta a un código para registrarlo</div>
                    <div id="log-list"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="beep-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        let scanner;
        let scanHistory = [];
        let activeTrack = null;
        let currentZoom = 1.0;

        async function initApp() {
            scanner = new Html5Qrcode("reader");
            
            const config = { 
                fps: 30,
                qrbox: (vw, vh) => {
                    const s = Math.min(vw, vh) * 0.8;
                    return { width: s, height: s };
                },
                aspectRatio: 1.0,
                videoConstraints: {
                    facingMode: "environment",
                    width: { ideal: 4096 },
                    height: { ideal: 2160 },
                    focusMode: "continuous"
                }
            };

            document.getElementById('main-btn').onclick = async function() {
                const text = document.getElementById('btn-text');
                if (text.innerText === "INICIAR") {
                    try {
                        await scanner.start({ facingMode: "environment" }, config, handleSuccess);
                        text.innerText = "DETENER";
                        this.classList.replace('bg-indigo-600', 'bg-red-500/10');
                        this.classList.add('text-red-500', 'border', 'border-red-500/50');
                        document.getElementById('btn-icon').style.display = 'none';
                        document.getElementById('zoom-ctrl').classList.remove('hidden');
                        
                        setTimeout(autoConfigureCamera, 1000);
                    } catch (e) { alert("Acceso denegado: " + e); }
                } else {
                    location.reload(); // Reinicio limpio para la cámara
                }
            };
        }

        async function autoConfigureCamera() {
            activeTrack = scanner.getRunningTrack();
            const caps = activeTrack.getCapabilities();
            const slider = document.getElementById('zoom-slider');
            const display = document.getElementById('zoom-display');

            if (caps.zoom) {
                slider.min = caps.zoom.min;
                slider.max = caps.zoom.max;
                slider.step = caps.zoom.step;
                slider.value = 1.0;

                const setZoom = (val) => {
                    activeTrack.applyConstraints({ advanced: [{ zoom: val }] });
                    display.innerText = parseFloat(val).toFixed(1) + "x";
                    currentZoom = val;
                };

                slider.oninput = (e) => setZoom(e.target.value);
                document.getElementById('zoom-up').onclick = () => {
                    let v = Math.min(parseFloat(slider.value) + 0.5, caps.zoom.max);
                    slider.value = v; setZoom(v);
                };
                document.getElementById('zoom-down').onclick = () => {
                    let v = Math.max(parseFloat(slider.value) - 0.5, caps.zoom.min);
                    slider.value = v; setZoom(v);
                };

                // Lógica de "Smart Auto-Zoom"
                // Si tras 3 segundos no hay captura exitosa, intentamos un leve zoom automático
                setTimeout(() => {
                    if (scanHistory.length === 0 && currentZoom < 1.5) {
                        slider.value = 1.6;
                        setZoom(1.6);
                        document.getElementById('status-pill').innerText = "Optimizando para distancia...";
                    }
                }, 4000);
            }
        }

        function handleSuccess(decodedText) {
            // Evitar duplicados inmediatos
            if (scanHistory.length > 0 && scanHistory[0].data === decodedText) return;

            document.getElementById('beep-sound').play();
            if (navigator.vibrate) navigator.vibrate(120);

            const record = {
                data: decodedText,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
            };

            scanHistory.unshift(record);
            updateUI();
            
            // Efecto visual de captura exitosa
            const pill = document.getElementById('status-pill');
            pill.innerText = "¡CAPTURA EXITOSA!";
            pill.style.background = "#10b981";
            setTimeout(() => {
                pill.innerText = "Escaneando...";
                pill.style.background = "";
            }, 1500);
        }

        function updateUI() {
            const list = document.getElementById('log-list');
            const msg = document.getElementById('empty-msg');
            msg.style.display = scanHistory.length ? 'none' : 'block';
            
            list.innerHTML = scanHistory.map(s => `
                <div class="bg-zinc-800/50 p-4 rounded-2xl flex justify-between items-center border border-white/5 animate-in slide-in-from-right duration-300">
                    <span class="text-xs font-black text-indigo-400 font-mono">${s.time}</span>
                    <span class="text-sm font-bold text-zinc-100 truncate ml-4 flex-1 text-right">${s.data}</span>
                </div>
            `).join('');
        }

        document.getElementById('dl-btn').onclick = () => {
            if (!scanHistory.length) return;
            const ws = XLSX.utils.json_to_sheet(scanHistory);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, `Inventario_Digital_${Date.now()}.xlsx`);
        };

        document.getElementById('clear-all').onclick = () => {
            if (confirm("¿Borrar todos los registros?")) {
                scanHistory = [];
                updateUI();
            }
        };

        window.onload = initApp;
    </script>
</body>
</html>
